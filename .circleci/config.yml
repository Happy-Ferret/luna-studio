version: 2
jobs:
  backend:
    environment:
      GHC_RTS: -M3G
    docker:
      - image: fpco/stack-build:lts-9
    steps:
      - checkout
      - run: stack setup --stack-yaml=build-config/backend/stack.yaml
      - run: stack build --stack-yaml=build-config/backend/stack.yaml --fast
  frontend:
    docker:
      - image: fpco/stack-build:lts-9
    steps:
      - checkout
      - run:
          command: |
                set +e
                curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.5/install.sh | bash
                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                nvm install lts/boron
                nvm alias default lts/boron
                touch $BASH_ENV
                # Each step uses the same `$BASH_ENV`, so need to modify it
                echo 'export NVM_DIR="/opt/circleci/.nvm"' >> $BASH_ENV
                echo "[ -s \"$NVM_DIR/nvm.sh\" ] && . \"$NVM_DIR/nvm.sh\"" >> $BASH_ENV

                stack setup --stack-yaml=luna-studio/stack.yaml --ghcjs-boot-options --no-prof
                stack build --stack-yaml=luna-studio/stack.yaml --fast
workflows:
  version: 2
  percommit:
    jobs:
      - backend
      - frontend
