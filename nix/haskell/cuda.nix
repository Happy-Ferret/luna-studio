# This file was auto-generated by cabal2nix. Please do NOT edit manually!

{ cabal, c2hs, cudatoolkit, nvidia_x11, fetchgit,
  autoconf, ghc
}:

cabal.mkDerivation (self: {
  pname = "cuda";
  version = "0.6.1.0";
  src = fetchgit {
    url = https://github.com/tmcdonell/cuda.git;
    rev = "13c38078b85f6c65727972134e9d89316872532f";
    sha256 = "0m8dl6x3lm8gchb58ni3c8f1yk86p1y18bld63w8q2l7p6w8ghvx";
  };
  buildTools = [ c2hs ];
  noHaddock = true;
  doCheck = false;
  buildInputs = [ autoconf ghc c2hs ];
  extraLibraries = [ cudatoolkit nvidia_x11 self.stdenv.gcc ];
  # Perhaps this should be the default in cabal.nix ...
  #
  # The cudatoolkit provides both 64 and 32-bit versions of the
  # library. GHC's linker fails if the wrong version is found first.
  # We solve this by eliminating lib64 from the path on 32-bit
  # platforms and putting lib64 first on 64-bit platforms.
  libPaths = if self.stdenv.is64bit then "lib64 lib" else "lib";
  configurePhase = ''
    for i in Setup.hs Setup.lhs; do
      test -f $i && ghc --make $i
    done
    for p in $extraBuildInputs $propagatedNativeBuildInputs; do
      if [ -d "$p/include" ]; then
        extraLibDirs="$extraLibDirs --extra-include-dir=$p/include"
      fi
      for d in $libPaths; do
        if [ -d "$p/$d" ]; then
          extraLibDirs="$extraLibDirs --extra-lib-dir=$p/$d"
        fi
      done
    done
    ./Setup configure --verbose --prefix="$out" $libraryProfiling $extraLibDirs $configureFlags
  '';
  meta = {
    homepage = "https://github.com/tmcdonell/cuda";
    description = "FFI binding to the CUDA interface for programming NVIDIA GPUs";
    license = self.stdenv.lib.licenses.bsd3;
    platforms = self.ghc.meta.platforms;
  };
})
