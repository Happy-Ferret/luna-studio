#!/usr/bin/python
import sys
import os.path
import sys
from subprocess import call, Popen, PIPE
from utils.colors import print_info, print_error, print_warning
from itertools import chain
from collections import deque
import ConfigParser
import os.path


def handle_ret(ret):
    if ret != 0:
        sys.exit(ret)

def main():
    cwd = os.getcwd()
    dist_dir = os.path.join(cwd, 'dist')
    bin_dir = os.path.join(dist_dir, 'bin')

    cfgname = '.build.config'
    if not os.path.isfile(cfgname):
        print_error("No build configuration file found. Run 'workon' script.")
        sys.exit(1)
    
    config = ConfigParser.RawConfigParser()
    config.read(cfgname)

    print_info("Binary path is set to '%s'" % bin_dir)
    
    names    = config.get('Target', 'names').split(',')
    binpaths = config.get('Target', 'binpaths').split(',')
    for (name, path) in zip(names, binpaths):
        inst_path = os.path.join(bin_dir, path)
        print_info("Compiling %s [-> %s]" % (name, path))
        ret = call(['cabal', 'install', '--reinstall', '--bindir=%s'%inst_path, name] + sys.argv[1:])
        handle_ret(ret)
    sys.exit(0)

main()


